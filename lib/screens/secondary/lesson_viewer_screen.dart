import 'dart:async';
import 'dart:io';
import 'package:flutter/material.dart';
import 'package:flutter/foundation.dart';
import 'package:flutter/services.dart';
import 'package:go_router/go_router.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:http/http.dart' as http;
import 'package:path_provider/path_provider.dart';
import 'package:pod_player/pod_player.dart';
import 'package:webview_flutter/webview_flutter.dart';
import '../../core/design/app_colors.dart';
import '../../core/navigation/route_names.dart';
import '../../services/courses_service.dart';
import '../../services/token_storage_service.dart';

/// Lesson Viewer Screen - Modern & Eye-Friendly Design
class LessonViewerScreen extends StatefulWidget {
  final Map<String, dynamic>? lesson;
  final String? courseId;

  const LessonViewerScreen({super.key, this.lesson, this.courseId});

  @override
  State<LessonViewerScreen> createState() => _LessonViewerScreenState();
}

class _LessonViewerScreenState extends State<LessonViewerScreen> {
  PodPlayerController? _controller;
  WebViewController? _webViewController;
  bool _isVideoLoading = true;
  bool _isLoadingContent = true;
  bool _useWebViewFallback = false;
  Map<String, dynamic>? _lessonContent;
  File? _tempVideoFile;

  @override
  void initState() {
    super.initState();
    _loadLessonContent().then((_) {
      // Initialize video after content is loaded (or failed)
      // This ensures we can use video data from the API response
      _initializeVideo();
    });
  }

  Future<void> _loadLessonContent() async {
    final lesson = widget.lesson;
    if (lesson == null) {
      setState(() {
        _isLoadingContent = false;
      });
      return;
    }

    // Get courseId from widget or extract from lesson
    String? courseId = widget.courseId;
    if (courseId == null || courseId.isEmpty) {
      courseId =
          lesson['course_id']?.toString() ?? lesson['courseId']?.toString();
    }

    final lessonId = lesson['id']?.toString();

    if (courseId == null ||
        courseId.isEmpty ||
        lessonId == null ||
        lessonId.isEmpty) {
      setState(() {
        _isLoadingContent = false;
      });
      return;
    }

    try {
      final content = await CoursesService.instance.getLessonContent(
        courseId,
        lessonId,
      );

      if (mounted) {
        setState(() {
          _lessonContent = content;
          _isLoadingContent = false;
        });
      }
    } catch (e) {
      if (kDebugMode) {
        print('‚ùå Error loading lesson content: $e');
      }
      if (mounted) {
        setState(() {
          _isLoadingContent = false;
        });
      }
    }
  }

  /// Clean and normalize video URL
  String? _cleanVideoUrl(String? url) {
    if (url == null || url.isEmpty) return null;

    // Remove any blob: prefix if present at the start
    url = url.replaceFirst(RegExp(r'^blob:'), '').trim();

    // Fix URLs that have blob: in the middle (like "https://domain.com/blob:https://...")
    if (url.contains('blob:')) {
      final blobIndex = url.indexOf('blob:');
      if (blobIndex != -1) {
        final afterBlob =
            url.substring(blobIndex + 5).trim(); // 5 is length of "blob:"
        // If the part after blob: starts with http/https, use it directly
        if (afterBlob.startsWith('http://') ||
            afterBlob.startsWith('https://')) {
          url = afterBlob;
        } else {
          // Otherwise, remove the blob: part and keep everything before and after
          url = url.substring(0, blobIndex).trim() + afterBlob;
        }
      }
    }

    // Ensure URL is valid
    if (!url.startsWith('http://') && !url.startsWith('https://')) {
      if (kDebugMode) {
        print('‚ö†Ô∏è Invalid video URL format: $url');
      }
      return null;
    }

    return url.trim();
  }

  Future<void> _initializeVideo() async {
    final lesson = widget.lesson;
    if (lesson == null) {
      setState(() => _isVideoLoading = false);
      return;
    }

    // Wait for content to load, then use it for video
    // If content is already loaded, use it; otherwise use lesson data
    final videoData = _lessonContent?['video'] ?? lesson['video'];

    // Extract video ID from lesson content or lesson - try all possible fields
    String? videoId;
    String? videoUrl;

    // 1. Try video_url field directly from lesson (highest priority)
    videoUrl = _cleanVideoUrl(lesson['video_url']?.toString());

    // 2. Try video object with youtube_id from content
    if (videoUrl == null && videoData is Map) {
      videoId = videoData['youtube_id']?.toString();
      videoUrl = _cleanVideoUrl(videoData['url']?.toString());
    }

    // 3. Try video object with youtube_id from lesson
    if (videoUrl == null && lesson['video'] is Map) {
      videoId = lesson['video']?['youtube_id']?.toString();
      videoUrl = _cleanVideoUrl(lesson['video']?['url']?.toString());
    }

    // 4. Try direct youtube_id field
    videoId = videoId ?? lesson['youtube_id']?.toString();

    // 5. Try youtubeVideoId field
    videoId = videoId ?? lesson['youtubeVideoId']?.toString();

    // 6. If no video object, use lesson id as video id
    if (videoId == null || videoId.isEmpty) {
      videoId = lesson['id']?.toString();
    }

    videoId = videoId ?? '';

    if (kDebugMode) {
      print('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      print('üé• INITIALIZING VIDEO IN LESSON VIEWER');
      print('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      print('Video ID: $videoId');
      print('Video URL (cleaned): $videoUrl');
      print('Lesson ID: ${lesson['id']}');
      print('Lesson Title: ${lesson['title']}');
      print('Video Object: $videoData');
      print('Raw video_url: ${lesson['video_url']}');
      print('All Lesson Keys: ${lesson.keys.toList()}');
      print('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    }

    try {
      // Use video URL if available, otherwise use YouTube ID
      if (videoUrl != null && videoUrl.isNotEmpty) {
        // Check if it's a YouTube URL
        if (videoUrl.contains('youtube.com') || videoUrl.contains('youtu.be')) {
          if (kDebugMode) {
            print('üì∫ Using YouTube URL: $videoUrl');
          }
          _controller = PodPlayerController(
            playVideoFrom: PlayVideoFrom.youtube(videoUrl),
            podPlayerConfig: const PodPlayerConfig(
              autoPlay: false,
              isLooping: false,
            ),
          )..initialise().then((_) {
              if (mounted) {
                setState(() => _isVideoLoading = false);
              }
            }).catchError((error) {
              if (kDebugMode) {
                print('‚ùå Error initializing YouTube video: $error');
              }
              if (mounted) {
                setState(() => _isVideoLoading = false);
              }
            });
        } else {
          // Direct video URL from server - use pod_player with network
          if (kDebugMode) {
            print('üìπ Using pod_player for direct video URL: $videoUrl');
          }
          _initializeDirectVideo(videoUrl);
        }
      } else if (videoId.isNotEmpty) {
        // Fallback to YouTube ID
        if (kDebugMode) {
          print('üì∫ Using YouTube ID fallback: $videoId');
        }
        final youtubeUrl = 'https://www.youtube.com/watch?v=$videoId';
        _controller = PodPlayerController(
          playVideoFrom: PlayVideoFrom.youtube(youtubeUrl),
          podPlayerConfig: const PodPlayerConfig(
            autoPlay: false,
            isLooping: false,
          ),
        )..initialise().then((_) {
            if (mounted) {
              setState(() => _isVideoLoading = false);
            }
          }).catchError((error) {
            if (kDebugMode) {
              print('‚ùå Error initializing YouTube video by ID: $error');
            }
            if (mounted) {
              setState(() => _isVideoLoading = false);
            }
          });
      } else {
        // No valid video source
        if (kDebugMode) {
          print('‚ö†Ô∏è No valid video source found');
        }
        if (mounted) {
          setState(() => _isVideoLoading = false);
        }
      }
    } catch (e) {
      if (kDebugMode) {
        print('‚ùå Error initializing video: $e');
      }
      if (mounted) {
        setState(() => _isVideoLoading = false);
      }
    }
  }

  /// Initialize direct video playback using pod_player
  Future<void> _initializeDirectVideo(String videoUrl) async {
    try {
      if (kDebugMode) {
        print('üìπ Initializing direct video with pod_player: $videoUrl');
      }

      // Get authorization token for video access
      final token = await TokenStorageService.instance.getAccessToken();

      // Add token as query parameter if available
      String videoUrlWithToken = videoUrl;
      if (token != null && token.isNotEmpty) {
        final uri = Uri.parse(videoUrl);
        videoUrlWithToken = uri.replace(queryParameters: {
          ...uri.queryParameters,
          'token': token,
        }).toString();

        if (kDebugMode) {
          print('üîë Added token to video URL');
        }
      }

      // Use pod_player with PlayVideoFrom.network()
      _controller = PodPlayerController(
        playVideoFrom: PlayVideoFrom.network(videoUrlWithToken),
        podPlayerConfig: const PodPlayerConfig(
          autoPlay: false,
          isLooping: false,
        ),
      )..initialise().then((_) {
          if (mounted) {
            setState(() {
              _isVideoLoading = false;
              _useWebViewFallback = false;
            });
          }
          if (kDebugMode) {
            print('‚úÖ Direct video initialized successfully with pod_player');
          }
        }).catchError((error) {
          if (kDebugMode) {
            print('‚ùå Error initializing direct video with pod_player: $error');
            print('   Falling back to WebView...');
          }
          // Fallback to WebView if pod_player fails
          if (mounted) {
            _initializeWebView(videoUrl);
          }
        });
    } catch (e) {
      if (kDebugMode) {
        print('‚ùå Error in _initializeDirectVideo: $e');
        print('   Falling back to WebView...');
      }
      // Fallback to WebView if there's an error
      if (mounted) {
        _initializeWebView(videoUrl);
      }
    }
  }

  /// Initialize WebView for direct video playback (fallback method)
  Future<void> _initializeWebView(String videoUrl) async {
    try {
      if (kDebugMode) {
        print('üåê Initializing WebView for video playback: $videoUrl');
      }

      // Get authorization token for video access
      final token = await TokenStorageService.instance.getAccessToken();

      setState(() {
        _useWebViewFallback = true;
      });

      // Try to load video via Flutter HTTP request first (to bypass CORS)
      // Then pass it to WebView as blob URL
      try {
        if (kDebugMode) {
          print('üì• Loading video via Flutter HTTP request...');
        }

        final headers = <String, String>{};
        if (token != null && token.isNotEmpty) {
          headers['Authorization'] = 'Bearer $token';
        }

        // Load video and save to temporary file
        final response = await http
            .get(
              Uri.parse(videoUrl),
              headers: headers,
            )
            .timeout(const Duration(seconds: 60));

        if (response.statusCode == 200) {
          if (kDebugMode) {
            print(
                '‚úÖ Video loaded successfully via HTTP (${response.bodyBytes.length} bytes)');
          }

          // Save to temporary file
          final tempDir = await getTemporaryDirectory();
          final fileName = videoUrl.split('/').last.split('?').first;
          final fileExtension = fileName.split('.').last;
          final tempFile = File(
              '${tempDir.path}/video_${DateTime.now().millisecondsSinceEpoch}.$fileExtension');

          await tempFile.writeAsBytes(response.bodyBytes);

          if (kDebugMode) {
            print('üíæ Video saved to temporary file: ${tempFile.path}');
          }

          // Use file:// URL for WebView
          final fileUrl = tempFile.path;
          _createWebViewWithFileUrl(fileUrl);

          // Store reference to temp file for cleanup
          setState(() {
            _tempVideoFile = tempFile;
          });

          return;
        } else {
          if (kDebugMode) {
            print('‚ùå HTTP request failed with status: ${response.statusCode}');
          }
        }
      } catch (e) {
        if (kDebugMode) {
          print('‚ö†Ô∏è Failed to load video via HTTP: $e');
          print('   Falling back to direct WebView method...');
        }
      }

      // Fallback: Try direct WebView method

      _createWebViewWithDirectUrl(videoUrl, token);
    } catch (e) {
      if (kDebugMode) {
        print('‚ùå Error initializing WebView: $e');
      }
      if (mounted) {
        setState(() {
          _isVideoLoading = false;
        });
      }
    }
  }

  /// Create WebView with file URL (from temporary file)
  void _createWebViewWithFileUrl(String filePath) {
    // Convert file path to file:// URL
    final fileUrl =
        Platform.isAndroid ? 'file://$filePath' : 'file://$filePath';

    final htmlContent = '''
<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      width: 100%;
      height: 100%;
      background-color: #000;
      overflow: hidden;
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background-color: #000;
    }
  </style>
</head>
<body>
  <video id="videoPlayer" controls autoplay playsinline webkit-playsinline>
    <source src="$fileUrl" type="video/mp4">
    Your browser does not support the video tag.
  </video>
  <script>
    var video = document.getElementById('videoPlayer');
    video.addEventListener('loadeddata', function() {
      console.log('Video loaded successfully from file URL');
    });
    video.addEventListener('error', function(e) {
      console.error('Video error:', e);
      var error = video.error;
      if (error) {
        console.error('Error code:', error.code, 'Message:', error.message);
      }
    });
  </script>
</body>
</html>
''';

    _webViewController = WebViewController()
      ..setJavaScriptMode(JavaScriptMode.unrestricted)
      ..setBackgroundColor(Colors.black)
      ..setNavigationDelegate(
        NavigationDelegate(
          onPageFinished: (String url) {
            if (kDebugMode) {
              print('‚úÖ WebView page finished: $url');
            }
            if (mounted) {
              setState(() {
                _isVideoLoading = false;
              });
            }
          },
          onWebResourceError: (WebResourceError error) {
            if (kDebugMode) {
              print('‚ùå WebView resource error: ${error.description}');
            }
            if (mounted) {
              setState(() {
                _isVideoLoading = false;
              });
            }
          },
        ),
      )
      ..loadHtmlString(htmlContent);

    if (mounted) {
      Future.delayed(const Duration(milliseconds: 500), () {
        if (mounted) {
          setState(() {
            _isVideoLoading = false;
          });
        }
      });
    }
  }

  /// Create WebView with direct URL (fallback method)
  void _createWebViewWithDirectUrl(String videoUrl, String? token) {
    // Build video URL with token as query parameter (fallback method)
    String videoUrlWithToken = videoUrl;
    if (token != null && token.isNotEmpty) {
      final uri = Uri.parse(videoUrl);
      videoUrlWithToken = uri.replace(queryParameters: {
        ...uri.queryParameters,
        'token': token,
      }).toString();
    }

    // Create HTML5 video player with multiple fallback methods
    final htmlContent = '''
<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      width: 100%;
      height: 100%;
      background-color: #000;
      overflow: hidden;
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background-color: #000;
    }
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    .error {
      color: #ff6b6b;
    }
  </style>
</head>
<body>
  <div class="loading" id="loading">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÅŸäÿØŸäŸà...</div>
  <video id="videoPlayer" controls autoplay playsinline webkit-playsinline style="display: none;">
    Your browser does not support the video tag.
  </video>
  <script>
    var video = document.getElementById('videoPlayer');
    var loading = document.getElementById('loading');
    var videoUrl = '$videoUrl';
    var videoUrlWithToken = '$videoUrlWithToken';
    ${token != null ? "var token = '$token';" : 'var token = null;'}
    var currentMethod = 0;
    var methods = ['direct', 'no-cors', 'token-param'];
    
    function showVideo() {
      video.style.display = 'block';
      loading.style.display = 'none';
    }
    
    function showError(message) {
      loading.textContent = message;
      loading.className = 'loading error';
    }
    
    // Method 1: Try direct video source first (simplest, may work if server allows)
    function tryDirectVideo() {
      console.log('Trying method 1: Direct video source');
      video.src = videoUrl;
      video.load();
      
      var timeout = setTimeout(function() {
        if (video.readyState === 0) {
          console.log('Direct method failed, trying next method');
          tryNoCorsFetch();
        }
      }, 3000);
      
      video.addEventListener('loadeddata', function() {
        clearTimeout(timeout);
        console.log('Direct method succeeded');
        showVideo();
      }, { once: true });
      
      video.addEventListener('error', function(e) {
        clearTimeout(timeout);
        console.log('Direct method failed:', e);
        tryNoCorsFetch();
      }, { once: true });
    }
    
    // Method 2: Try fetch with no-cors mode
    async function tryNoCorsFetch() {
      console.log('Trying method 2: Fetch with no-cors mode');
      try {
        var response = await fetch(videoUrl, {
          method: 'GET',
          mode: 'no-cors',
          cache: 'default'
        });
        
        // With no-cors, we can't read the response, but we can try to use it
        // Try to create a blob URL anyway
        if (response.type === 'opaque') {
          // Opaque response - try to use video tag with the URL directly
          console.log('Got opaque response, trying direct video');
          video.src = videoUrl;
          video.load();
          
          video.addEventListener('loadeddata', function() {
            console.log('Video loaded after no-cors fetch');
            showVideo();
          }, { once: true });
          
          video.addEventListener('error', function(e) {
            console.log('No-cors method failed:', e);
            tryTokenParam();
          }, { once: true });
        }
      } catch (error) {
        console.log('No-cors fetch failed:', error);
        tryTokenParam();
      }
    }
    
    // Method 3: Try with token as query parameter
    function tryTokenParam() {
      if (!token) {
        showError('ŸÑÿß ŸäŸÖŸÉŸÜ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÅŸäÿØŸäŸà');
        return;
      }
      
      console.log('Trying method 3: Token as query parameter');
      video.src = videoUrlWithToken;
      video.load();
      
      video.addEventListener('loadeddata', function() {
        console.log('Token param method succeeded');
        showVideo();
      }, { once: true });
      
      video.addEventListener('error', function(e) {
        console.log('Token param method failed:', e);
        showError('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÅŸäÿØŸäŸà. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™.');
      }, { once: true });
    }
    
    // Add error handlers
    video.addEventListener('error', function(e) {
      var error = video.error;
      if (error) {
        console.error('Video error code:', error.code, 'Message:', error.message);
        if (error.code === 4) {
          // MEDIA_ELEMENT_ERROR: Format error
          showError('ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑŸÅŸäÿØŸäŸà ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖ');
        } else if (error.code === 3) {
          // MEDIA_ELEMENT_ERROR: Decode error
          showError('ÿÆÿ∑ÿ£ ŸÅŸä ŸÅŸÉ ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑŸÅŸäÿØŸäŸà');
        } else if (error.code === 2) {
          // MEDIA_ELEMENT_ERROR: Network error
          showError('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ¥ÿ®ŸÉÿ©');
        } else {
          showError('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÅŸäÿØŸäŸà');
        }
      }
    });
    
    // Start loading
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', tryDirectVideo);
    } else {
      tryDirectVideo();
    }
  </script>
</body>
</html>
''';

    _webViewController = WebViewController()
      ..setJavaScriptMode(JavaScriptMode.unrestricted)
      ..setBackgroundColor(Colors.black)
      ..setNavigationDelegate(
        NavigationDelegate(
          onPageStarted: (String url) {
            if (kDebugMode) {
              print('üåê WebView page started: $url');
            }
          },
          onPageFinished: (String url) {
            if (kDebugMode) {
              print('‚úÖ WebView page finished: $url');
            }
            if (mounted) {
              setState(() {
                _isVideoLoading = false;
              });
            }
          },
          onWebResourceError: (WebResourceError error) {
            if (kDebugMode) {
              print('‚ùå WebView resource error: ${error.description}');
              print('   Error code: ${error.errorCode}');
              print('   Error type: ${error.errorType}');
              print('   Failed URL: ${error.url}');

              // Log specific error types
              if (error.errorCode == -1) {
                print(
                    '   ‚ö†Ô∏è CORS or ORB (Opaque Response Blocking) error detected');
                print(
                    '   üí° This is expected - JavaScript will handle fallback methods');
              }
            }
            // Don't set loading to false immediately - let JavaScript try fallback methods
            // Only set to false if it's a critical error
            if (error.errorType == WebResourceErrorType.hostLookup ||
                error.errorType == WebResourceErrorType.timeout) {
              if (mounted) {
                setState(() {
                  _isVideoLoading = false;
                });
              }
            }
          },
        ),
      )
      ..loadHtmlString(htmlContent);

    if (mounted) {
      Future.delayed(const Duration(milliseconds: 500), () {
        if (mounted) {
          setState(() {
            _isVideoLoading = false;
          });
        }
      });
    }
  }

  @override
  void dispose() {
    _controller?.dispose();
    // Clean up temporary video file
    if (_tempVideoFile != null) {
      try {
        _tempVideoFile!.deleteSync();
      } catch (e) {
        if (kDebugMode) {
          print('‚ö†Ô∏è Error deleting temp video file: $e');
        }
      }
    }
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    SystemChrome.setSystemUIOverlayStyle(
      const SystemUiOverlayStyle(
        statusBarColor: Colors.transparent,
        statusBarIconBrightness: Brightness.light,
      ),
    );

    final lesson = widget.lesson;
    if (lesson == null) {
      return Scaffold(
        backgroundColor: const Color(0xFF0F0F1A),
        body: Center(
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              const Icon(Icons.error_outline, size: 64, color: Colors.white54),
              const SizedBox(height: 16),
              Text(
                'ŸÑÿß ŸäŸàÿ¨ÿØ ÿØÿ±ÿ≥',
                style: GoogleFonts.cairo(color: Colors.white, fontSize: 18),
              ),
            ],
          ),
        ),
      );
    }

    return Scaffold(
      backgroundColor: const Color(0xFF0F0F1A),
      body: SafeArea(
        top: false,
        child: Column(
          children: [
            // Video Player Section
            _buildVideoSection(lesson),

            // Lesson Info Section
            Expanded(
              child: _buildLessonInfo(lesson),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildVideoSection(Map<String, dynamic> lesson) {
    return Container(
      color: Colors.black,
      child: Column(
        children: [
          // Header
          Container(
            padding: EdgeInsets.only(
              top: MediaQuery.of(context).padding.top + 8,
              left: 16,
              right: 16,
              bottom: 8,
            ),
            child: Row(
              children: [
                GestureDetector(
                  onTap: () => context.pop(),
                  child: Container(
                    width: 40,
                    height: 40,
                    decoration: BoxDecoration(
                      color: Colors.white.withOpacity(0.1),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: const Icon(Icons.arrow_back_ios_new_rounded,
                        color: Colors.white, size: 18),
                  ),
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        lesson['title'] as String? ?? 'ÿπŸÜŸàÿßŸÜ ÿßŸÑÿØÿ±ÿ≥',
                        style: GoogleFonts.cairo(
                          fontSize: 16,
                          fontWeight: FontWeight.bold,
                          color: Colors.white,
                        ),
                        maxLines: 1,
                        overflow: TextOverflow.ellipsis,
                      ),
                      Text(
                        'ÿßŸÑŸÖÿØÿ©: ${lesson['duration'] ?? 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}',
                        style: GoogleFonts.cairo(
                          fontSize: 12,
                          color: Colors.white60,
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),

          // Video Player
          SizedBox(
            height: 220,
            child: _isVideoLoading
                ? Container(
                    color: Colors.black,
                    child: const Center(
                      child: CircularProgressIndicator(
                        color: AppColors.purple,
                      ),
                    ),
                  )
                : _controller != null
                    ? PodVideoPlayer(
                        controller: _controller!,
                        videoAspectRatio: 16 / 9,
                        podProgressBarConfig: const PodProgressBarConfig(
                          playingBarColor: AppColors.purple,
                          circleHandlerColor: AppColors.purple,
                          bufferedBarColor: Colors.white30,
                        ),
                      )
                    : _useWebViewFallback && _webViewController != null
                        ? WebViewWidget(controller: _webViewController!)
                        : Container(
                            color: Colors.black,
                            child: Center(
                              child: Column(
                                mainAxisAlignment: MainAxisAlignment.center,
                                children: [
                                  const Icon(Icons.error_outline,
                                      color: Colors.white54, size: 48),
                                  const SizedBox(height: 12),
                                  Text(
                                    'ŸÑÿß ŸäŸÖŸÉŸÜ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÅŸäÿØŸäŸà',
                                    style: GoogleFonts.cairo(
                                      color: Colors.white54,
                                      fontSize: 14,
                                    ),
                                  ),
                                ],
                              ),
                            ),
                          ),
          ),
        ],
      ),
    );
  }

  Widget _buildLessonInfo(Map<String, dynamic> lesson) {
    return Container(
      decoration: const BoxDecoration(
        color: Color(0xFFF8F9FC),
        borderRadius: BorderRadius.vertical(top: Radius.circular(32)),
      ),
      child: SingleChildScrollView(
        physics: const BouncingScrollPhysics(),
        padding: const EdgeInsets.all(24),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Drag Handle
            Center(
              child: Container(
                width: 40,
                height: 4,
                decoration: BoxDecoration(
                  color: Colors.grey[300],
                  borderRadius: BorderRadius.circular(2),
                ),
              ),
            ),
            const SizedBox(height: 20),

            // Lesson Title & Stats
            Text(
              lesson['title'] as String? ?? 'ÿπŸÜŸàÿßŸÜ ÿßŸÑÿØÿ±ÿ≥',
              style: GoogleFonts.cairo(
                fontSize: 22,
                fontWeight: FontWeight.bold,
                color: AppColors.foreground,
              ),
            ),
            const SizedBox(height: 12),

            // Stats Row
            Row(
              children: [
                _buildStatBadge(
                    Icons.access_time_rounded, lesson['duration'] ?? '0'),
                // const SizedBox(width: 12),
                // _buildStatBadge(Icons.visibility_rounded, '0 ŸÖÿ¥ÿßŸáÿØÿ©'),
                // const SizedBox(width: 12),
                // _buildStatBadge(Icons.thumb_up_rounded, '0%'),
              ],
            ),
            const SizedBox(height: 24),

            // Description Card
            Container(
              padding: const EdgeInsets.all(20),
              decoration: BoxDecoration(
                color: Colors.white,
                borderRadius: BorderRadius.circular(20),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black.withOpacity(0.04),
                    blurRadius: 20,
                    offset: const Offset(0, 4),
                  ),
                ],
              ),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    children: [
                      Container(
                        padding: const EdgeInsets.all(10),
                        decoration: BoxDecoration(
                          color: AppColors.purple.withOpacity(0.1),
                          borderRadius: BorderRadius.circular(12),
                        ),
                        child: const Icon(Icons.description_rounded,
                            color: AppColors.purple, size: 20),
                      ),
                      const SizedBox(width: 12),
                      Text(
                        'ŸàÿµŸÅ ÿßŸÑÿØÿ±ÿ≥',
                        style: GoogleFonts.cairo(
                          fontSize: 16,
                          fontWeight: FontWeight.bold,
                          color: AppColors.foreground,
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 16),
                  _isLoadingContent
                      ? const Center(
                          child: Padding(
                            padding: EdgeInsets.all(20.0),
                            child: CircularProgressIndicator(
                              color: AppColors.purple,
                            ),
                          ),
                        )
                      : Text(
                          _lessonContent?['description'] as String? ??
                              'ŸÑÿß ŸäŸàÿ¨ÿØ ŸàÿµŸÅ ŸÖÿ™ÿßÿ≠',
                          style: GoogleFonts.cairo(
                            fontSize: 14,
                            color: AppColors.mutedForeground,
                            height: 1.7,
                          ),
                        ),
                ],
              ),
            ),
            const SizedBox(height: 20),

            // Resources Card
            Container(
              padding: const EdgeInsets.all(20),
              decoration: BoxDecoration(
                color: Colors.white,
                borderRadius: BorderRadius.circular(20),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black.withOpacity(0.04),
                    blurRadius: 20,
                    offset: const Offset(0, 4),
                  ),
                ],
              ),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    children: [
                      Container(
                        padding: const EdgeInsets.all(10),
                        decoration: BoxDecoration(
                          color: Colors.orange.withOpacity(0.1),
                          borderRadius: BorderRadius.circular(12),
                        ),
                        child: const Icon(Icons.folder_rounded,
                            color: Colors.orange, size: 20),
                      ),
                      const SizedBox(width: 12),
                      Text(
                        'ŸÖŸÑŸÅÿßÿ™ ÿßŸÑÿØÿ±ÿ≥',
                        style: GoogleFonts.cairo(
                          fontSize: 16,
                          fontWeight: FontWeight.bold,
                          color: AppColors.foreground,
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 16),
                  _isLoadingContent
                      ? const Center(
                          child: Padding(
                            padding: EdgeInsets.all(20.0),
                            child: CircularProgressIndicator(
                              color: AppColors.purple,
                            ),
                          ),
                        )
                      : _buildResourcesList(),
                ],
              ),
            ),
            const SizedBox(height: 24),

            // Navigation Buttons
            Row(
              children: [
                Expanded(
                  child: _buildNavButton(
                    'ÿßŸÑÿØÿ±ÿ≥ ÿßŸÑÿ≥ÿßÿ®ŸÇ',
                    Icons.arrow_forward_rounded,
                    false,
                    () => context.pop(),
                  ),
                ),
                const SizedBox(width: 12),
                Expanded(
                  flex: 1,
                  child: _buildNavButton(
                    'ÿßŸÑÿØÿ±ÿ≥ ÿßŸÑÿ™ÿßŸÑŸä',
                    Icons.arrow_back_rounded,
                    true,
                    () => context.pop(),
                  ),
                ),
              ],
            ),
            const SizedBox(height: 20),
          ],
        ),
      ),
    );
  }

  Widget _buildStatBadge(IconData icon, String text) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.04),
            blurRadius: 8,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(icon, size: 14, color: AppColors.purple),
          const SizedBox(width: 6),
          Text(
            text,
            style: GoogleFonts.cairo(fontSize: 12, color: AppColors.foreground),
          ),
        ],
      ),
    );
  }

  Widget _buildResourcesList() {
    final resources = _lessonContent?['resources'] as List?;
    final contentPdf = _lessonContent?['content_pdf'] as String?;

    // Build list of resources
    final List<Map<String, dynamic>> resourceList = [];

    // Add PDF if available
    if (contentPdf != null && contentPdf.isNotEmpty) {
      resourceList.add({
        'title': 'ŸÖŸÑŸÅ PDF - ŸÖŸÑÿÆÿµ ÿßŸÑÿØÿ±ÿ≥',
        'url': contentPdf,
        'type': 'pdf',
        'icon': Icons.picture_as_pdf,
      });
    }

    // Add resources from API
    if (resources != null && resources.isNotEmpty) {
      for (var resource in resources) {
        if (resource is Map<String, dynamic>) {
          final title = resource['title']?.toString() ??
              resource['name']?.toString() ??
              'ŸÖŸÑŸÅ ŸÖÿ±ŸÅŸÇ';
          final url =
              resource['url']?.toString() ?? resource['file']?.toString() ?? '';
          final type = (resource['type']?.toString() ??
                  resource['file_type']?.toString() ??
                  '')
              .toLowerCase();

          IconData icon = Icons.insert_drive_file;
          if (type.contains('pdf')) {
            icon = Icons.picture_as_pdf;
          } else if (type.contains('zip') || type.contains('rar')) {
            icon = Icons.folder_zip;
          } else if (type.contains('image')) {
            icon = Icons.image;
          } else if (type.contains('video')) {
            icon = Icons.video_file;
          }

          resourceList.add({
            'title': title,
            'url': url,
            'type': type,
            'icon': icon,
            'size': resource['size']?.toString() ?? '',
          });
        }
      }
    }

    if (resourceList.isEmpty) {
      return Padding(
        padding: const EdgeInsets.all(20.0),
        child: Center(
          child: Text(
            'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÑŸÅÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ©',
            style: GoogleFonts.cairo(
              fontSize: 14,
              color: AppColors.mutedForeground,
            ),
          ),
        ),
      );
    }

    return Column(
      children: resourceList.asMap().entries.map((entry) {
        final index = entry.key;
        final resource = entry.value;
        return Column(
          children: [
            _buildResourceItem(
              resource['title'] as String,
              resource['size'] as String? ?? '',
              resource['icon'] as IconData,
              resource['url'] as String? ?? '',
            ),
            if (index < resourceList.length - 1) const SizedBox(height: 10),
          ],
        );
      }).toList(),
    );
  }

  Widget _buildResourceItem(
      String title, String size, IconData icon, String url) {
    // Check if the resource is a PDF
    final isPdf = url.toLowerCase().contains('.pdf') ||
        title.toLowerCase().contains('pdf') ||
        icon == Icons.picture_as_pdf;

    return GestureDetector(
      onTap: url.isNotEmpty
          ? () {
              if (kDebugMode) {
                print('Opening resource: $url');
              }

              if (isPdf) {
                // Open PDF in viewer screen
                context.push(
                  RouteNames.pdfViewer,
                  extra: {
                    'pdfUrl': url,
                    'title': title,
                  },
                );
              } else {
                // For non-PDF files, you can implement download or other actions
                if (kDebugMode) {
                  print('Non-PDF file: $url');
                }
              }
            }
          : null,
      child: Container(
        padding: const EdgeInsets.all(14),
        decoration: BoxDecoration(
          color: const Color(0xFFF8F9FC),
          borderRadius: BorderRadius.circular(14),
        ),
        child: Row(
          children: [
            Container(
              padding: const EdgeInsets.all(10),
              decoration: BoxDecoration(
                color: Colors.red.withOpacity(0.1),
                borderRadius: BorderRadius.circular(10),
              ),
              child: Icon(icon, color: Colors.red, size: 18),
            ),
            const SizedBox(width: 12),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    title,
                    style: GoogleFonts.cairo(
                        fontSize: 13,
                        fontWeight: FontWeight.w600,
                        color: AppColors.foreground),
                  ),
                  if (size.isNotEmpty)
                    Text(
                      size,
                      style: GoogleFonts.cairo(
                          fontSize: 11, color: AppColors.mutedForeground),
                    ),
                ],
              ),
            ),
            Container(
              padding: const EdgeInsets.all(8),
              decoration: BoxDecoration(
                color: isPdf
                    ? AppColors.purple.withOpacity(0.1)
                    : AppColors.purple.withOpacity(0.1),
                borderRadius: BorderRadius.circular(10),
              ),
              child: Icon(
                isPdf ? Icons.preview_rounded : Icons.download_rounded,
                color: AppColors.purple,
                size: 18,
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildNavButton(
      String text, IconData icon, bool isPrimary, VoidCallback onTap) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        padding: const EdgeInsets.symmetric(vertical: 16),
        decoration: BoxDecoration(
          gradient: isPrimary
              ? const LinearGradient(
                  colors: [Color(0xFF7C3AED), Color(0xFF5B21B6)])
              : null,
          color: isPrimary ? null : Colors.white,
          borderRadius: BorderRadius.circular(16),
          border: isPrimary ? null : Border.all(color: Colors.grey[200]!),
          boxShadow: isPrimary
              ? [
                  BoxShadow(
                    color: AppColors.purple.withOpacity(0.3),
                    blurRadius: 12,
                    offset: const Offset(0, 4),
                  ),
                ]
              : null,
        ),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            if (!isPrimary) Icon(icon, size: 18, color: AppColors.foreground),
            if (!isPrimary) const SizedBox(width: 8),
            Text(
              text,
              style: GoogleFonts.cairo(
                fontSize: 14,
                fontWeight: FontWeight.bold,
                color: isPrimary ? Colors.white : AppColors.foreground,
              ),
            ),
            if (isPrimary) const SizedBox(width: 8),
            if (isPrimary) Icon(icon, size: 18, color: Colors.white),
          ],
        ),
      ),
    );
  }
}
