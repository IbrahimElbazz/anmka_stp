import 'dart:io';
import 'package:flutter/foundation.dart';
import '../core/api/api_client.dart';
import '../core/api/api_endpoints.dart';

/// Service for user profile management
class ProfileService {
  ProfileService._();
  
  static final ProfileService instance = ProfileService._();

  /// Get user profile
  Future<Map<String, dynamic>> getProfile() async {
    try {
      final response = await ApiClient.instance.get(
        ApiEndpoints.me,
        requireAuth: true,
      );
      
      if (response['success'] == true && response['data'] != null) {
        return response['data'] as Map<String, dynamic>;
      } else {
        throw Exception(response['message'] ?? 'Failed to fetch profile');
      }
    } catch (e) {
      rethrow;
    }
  }

  /// Update user profile
  Future<Map<String, dynamic>> updateProfile({
    String? name,
    String? phone,
    String? bio,
    String? country,
    String? timezone,
    String? language,
  }) async {
    try {
      final body = <String, dynamic>{};
      if (name != null) body['name'] = name;
      if (phone != null) body['phone'] = phone;
      if (bio != null) body['bio'] = bio;
      if (country != null) body['country'] = country;
      if (timezone != null) body['timezone'] = timezone;
      if (language != null) body['language'] = language;

      final response = await ApiClient.instance.put(
        ApiEndpoints.profile,
        body: body,
        requireAuth: true,
      );
      
      if (response['success'] == true) {
        return response['data'] ?? {};
      } else {
        throw Exception(response['message'] ?? 'Failed to update profile');
      }
    } catch (e) {
      rethrow;
    }
  }

  /// Change password
  Future<void> changePassword({
    required String currentPassword,
    required String newPassword,
    required String newPasswordConfirmation,
  }) async {
    try {
      final response = await ApiClient.instance.post(
        ApiEndpoints.changePassword,
        body: {
          'current_password': currentPassword,
          'new_password': newPassword,
          'new_password_confirmation': newPasswordConfirmation,
        },
        requireAuth: true,
      );
      
      if (response['success'] != true) {
        throw Exception(response['message'] ?? 'Failed to change password');
      }
    } catch (e) {
      rethrow;
    }
  }

  /// Update preferences
  Future<void> updatePreferences({
    bool? emailNotifications,
    bool? pushNotifications,
    bool? marketingEmails,
    bool? courseReminders,
    bool? examReminders,
  }) async {
    try {
      final body = <String, dynamic>{};
      if (emailNotifications != null) body['email_notifications'] = emailNotifications;
      if (pushNotifications != null) body['push_notifications'] = pushNotifications;
      if (marketingEmails != null) body['marketing_emails'] = marketingEmails;
      if (courseReminders != null) body['course_reminders'] = courseReminders;
      if (examReminders != null) body['exam_reminders'] = examReminders;

      final response = await ApiClient.instance.put(
        ApiEndpoints.profile,
        body: body,
        requireAuth: true,
      );
      
      if (response['success'] != true) {
        throw Exception(response['message'] ?? 'Failed to update preferences');
      }
    } catch (e) {
      rethrow;
    }
  }

  /// Upload avatar image
  Future<Map<String, dynamic>> uploadAvatar(String imagePath) async {
    try {
      final file = File(imagePath);
      if (!await file.exists()) {
        throw Exception('Image file not found');
      }

      if (kDebugMode) {
        print('üì§ ProfileService: Uploading avatar from $imagePath');
        print('üì§ ProfileService: File exists: ${await file.exists()}');
        print('üì§ ProfileService: File size: ${await file.length()} bytes');
      }

      final response = await ApiClient.instance.postMultipart(
        ApiEndpoints.profile,
        fields: {},
        files: {'avatar': file},
        requireAuth: true,
      );
      
      if (kDebugMode) {
        print('üì• ProfileService: Upload response: $response');
      }
      
      if (response['success'] == true) {
        // Handle different response structures
        final data = response['data'];
        if (data != null) {
          // If data contains avatar directly
          if (data is Map<String, dynamic>) {
            return data;
          }
          // If data is a string or other type, return it wrapped
          return {'avatar': data};
        }
        // If no data, check if avatar is at root level
        if (response.containsKey('avatar')) {
          return {
            'avatar': response['avatar'],
            'avatar_thumbnail': response['avatar_thumbnail'],
          };
        }
        return {};
      } else {
        final errorMessage = response['message'] ?? 'Failed to upload avatar';
        throw Exception(errorMessage);
      }
    } catch (e) {
      if (kDebugMode) {
        print('‚ùå ProfileService: Avatar upload error: $e');
      }
      rethrow;
    }
  }
}

